<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="極電資訊 Apple MDM 專業知識庫身分驗證頁面。" />
    <title>登入 | 極電資訊 Apple MDM 知識庫</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="/superinfo_logo.png" />
    
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-hover: #0062cc;
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.4);
        --glass-shadow: 0 40px 100px rgba(0, 0, 0, 0.15);
        --text-main: #1d1d1f;
        --text-sec: #86868b;
        --error: #ff3b30;
        --success: #34c759;
        --radius: 24px;
        --transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
      }

      * {
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
      }

      body {
        font-family: "Inter", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: #f5f5f7;
        background-image: 
          radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.1) 0, transparent 50%),
          radial-gradient(at 100% 0%, rgba(90, 200, 250, 0.08) 0, transparent 50%),
          radial-gradient(at 50% 100%, rgba(0, 122, 255, 0.05) 0, transparent 50%);
        background-size: 100% 100%;
        background-attachment: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        color: var(--text-main);
        overflow-x: hidden;
      }

      main {
        width: 100%;
        max-width: 440px;
        padding: 24px;
        z-index: 10;
      }

      .card {
        background: var(--glass-bg);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 56px 40px;
        border-radius: var(--radius);
        box-shadow: var(--glass-shadow);
        border: 1px solid var(--glass-border);
        text-align: center;
        transition: var(--transition);
        animation: cardEntry 1s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      @keyframes cardEntry {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 50px 120px rgba(0, 0, 0, 0.18);
      }

      .logo-wrapper {
        margin-bottom: 32px;
        display: flex;
        justify-content: center;
      }

      .logo {
        max-width: 140px;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.05));
      }

      h1 {
        font-size: 26px;
        font-weight: 700;
        margin: 0 0 12px 0;
        letter-spacing: -0.03em;
      }

      .subtitle {
        color: var(--text-sec);
        font-size: 15px;
        margin: 0 0 36px 0;
        line-height: 1.6;
        font-weight: 400;
      }

      .form-group {
        margin-bottom: 24px;
        text-align: left;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-sec);
        margin-bottom: 8px;
        margin-left: 4px;
      }

      input {
        width: 100%;
        padding: 16px 20px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 14px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.7);
        outline: none;
        transition: all 0.25s ease;
        font-family: inherit;
      }

      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.12);
        background: #fff;
      }

      button {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      button:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 122, 255, 0.25);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status-badge {
        font-size: 12px;
        padding: 6px 14px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-sec);
        font-weight: 600;
        margin-top: 32px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
      }

      .status-online .dot {
        background: var(--success);
        box-shadow: 0 0 8px var(--success);
      }

      .status-offline .dot {
        background: var(--error);
      }

      .hidden {
        display: none !important;
      }

      .link-text {
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        margin-top: 20px;
        display: inline-block;
        transition: opacity 0.2s;
      }

      .link-text:hover {
        opacity: 0.8;
      }

      .message-box {
        min-height: 24px;
        margin-top: 20px;
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
      }
      
      .success { color: var(--success); }
      .error { color: var(--error); }

      .footer-note {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        font-size: 12px;
        color: #98989d;
        line-height: 1.8;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --glass-bg: rgba(28, 28, 30, 0.8);
          --glass-border: rgba(255, 255, 255, 0.1);
          --text-main: #ffffff;
        }
        body {
          background-color: #000000;
          background-image: 
            radial-gradient(at 0% 0%, rgba(10, 132, 255, 0.1) 0, transparent 40%),
            radial-gradient(at 100% 0%, rgba(100, 210, 255, 0.08) 0, transparent 40%),
            radial-gradient(at 50% 100%, rgba(10, 132, 255, 0.05) 0, transparent 50%);
        }
        input {
          background: rgba(255, 255, 255, 0.06);
          border-color: rgba(255, 255, 255, 0.1);
          color: white;
        }
        .status-badge { background: rgba(255, 255, 255, 0.1); }
        .footer-note { border-top-color: rgba(255, 255, 255, 0.1); }
      }
    </style>
  </head>
  <body>
    <main role="main">
      <div class="card">
        <header>
          <div class="logo-wrapper">
            <img src="/superinfo_logo.png" alt="極電資訊 Logo" class="logo" />
          </div>
          <h1>身分驗證</h1>
          <p class="subtitle">
            請使用教育網域信箱 (@*.edu.tw) 登入<br />以存取 MDM 專業知識庫
          </p>
        </header>

        <!-- 第 1 步：輸入電子郵件 -->
        <section id="step-email">
          <div class="form-group">
            <label for="email">及電子郵件地址</label>
            <input
              type="email"
              id="email"
              placeholder="username@school.edu.tw"
              required
              autocomplete="email"
              aria-required="true"
            />
          </div>
          <button id="btn-send" type="button">
            <div id="send-spinner" class="spinner hidden"></div>
            <span id="send-text">傳送驗證碼</span>
          </button>
        </section>

        <!-- 第 2 步：輸入驗證碼 (OTP) -->
        <section id="step-otp" class="hidden">
          <p id="otp-hint" style="color: var(--text-sec); margin-bottom: 24px; font-size: 14px"></p>
          <div class="form-group">
            <label for="otp">驗證碼</label>
            <input
              type="text"
              id="otp"
              placeholder="••••••"
              maxlength="6"
              inputmode="numeric"
              autocomplete="one-time-code"
              style="
                letter-spacing: 8px;
                text-align: center;
                font-weight: 700;
                font-size: 26px;
                padding-left: 28px;
              "
            />
          </div>
          <button id="btn-verify" type="button">
            <div id="verify-spinner" class="spinner hidden"></div>
            <span id="verify-text">登入系統</span>
          </button>
          <a href="#" id="link-retry" class="link-text">更換電子郵件</a>
        </section>

        <!-- 訊息與狀態回饋 -->
        <div id="message" class="message-box" aria-live="polite"></div>
        
        <div id="service-status" class="status-badge hidden">
          <span class="dot"></span>
          <span id="status-text">正在確認連線品質...</span>
        </div>

        <footer class="footer-note">
          本系統使用安全 Cookie 與雲端邊緣運算技術<br />
          維護您的存取安全 &copy; 2026 極電資訊
        </footer>
      </div>
    </main>

    <script>
      const elements = {
        stepEmail: document.getElementById("step-email"),
        stepOtp: document.getElementById("step-otp"),
        emailInput: document.getElementById("email"),
        otpInput: document.getElementById("otp"),
        msg: document.getElementById("message"),
        serviceStatus: document.getElementById("service-status"),
        statusText: document.getElementById("status-text"),
        btnSend: document.getElementById("btn-send"),
        btnVerify: document.getElementById("btn-verify"),
        sendSpinner: document.getElementById("send-spinner"),
        verifySpinner: document.getElementById("verify-spinner"),
        sendText: document.getElementById("send-text"),
        verifyText: document.getElementById("verify-text")
      };

      const log = (msg) => console.log(`[AuthSystem] ${msg}`);

      // 初始化：處理傳回的 Magic Link Token
      const getParams = () => {
        const hash = window.location.hash.substring(1);
        const search = window.location.search.substring(1);
        const p = new URLSearchParams(hash || search);
        return p;
      };

      const params = getParams();
      const accessToken = params.get("access_token");

      if (accessToken) {
        log("偵測到存取令牌，正在建立工作階段...");
        elements.stepEmail.classList.add("hidden");
        elements.msg.className = "message-box success";
        elements.msg.innerHTML = '<div class="spinner" style="display:inline-block; border-top-color:var(--success); margin-right:10px;"></div> 驗證成功，正在建立安全工作階段...';
        
        fetch("/auth/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ access_token: accessToken }),
        })
        .then(async (res) => {
          if (res.ok) {
            log("會話建立成功，準備導向...");
            setTimeout(() => location.href = "/", 500);
          } else {
            const err = await res.json();
            elements.msg.className = "message-box error";
            elements.msg.innerText = `驗證失敗：${err.error || "逾期或無效的連結"}`;
            elements.stepEmail.classList.remove("hidden");
          }
        })
        .catch(() => {
          elements.msg.className = "message-box error";
          elements.msg.innerText = "無法連線至驗證伺服器";
          elements.stepEmail.classList.remove("hidden");
        });
      }

      // 服務監測
      (async () => {
        try {
          const res = await fetch("/auth/health");
          if (!res.ok) throw new Error();
          const data = await res.json();
          elements.serviceStatus.classList.remove("hidden");
          if (data.status === "online") {
            elements.statusText.innerText = "已連線至安全驗證節點";
            elements.serviceStatus.className = "status-badge status-online";
          }
        } catch (e) {
          elements.serviceStatus.classList.remove("hidden");
          elements.statusText.innerText = "驗證服務連線中...";
          elements.serviceStatus.className = "status-badge status-offline";
        }
      })();

      // UI 輔助函式
      const setState = (action, loading) => {
        if (action === 'send') {
          elements.btnSend.disabled = loading;
          elements.sendSpinner.classList.toggle("hidden", !loading);
          elements.sendText.innerText = loading ? "請求中..." : "傳送驗證碼";
        } else {
          elements.btnVerify.disabled = loading;
          elements.verifySpinner.classList.toggle("hidden", !loading);
          elements.verifyText.innerText = loading ? "校驗中..." : "登入系統";
        }
      };

      // 事件監聽
      document.getElementById("btn-send").onclick = async () => {
        const email = elements.emailInput.value.trim();
        if (!email || !email.includes("@")) {
          elements.msg.className = "message-box error";
          elements.msg.innerText = "請輸入正確的電子郵件格式";
          return;
        }

        elements.msg.innerText = "";
        setState('send', true);

        try {
          const res = await fetch("/auth/otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          const data = await res.json();

          if (res.ok) {
            elements.stepEmail.classList.add("hidden");
            elements.stepOtp.classList.remove("hidden");
            document.getElementById("otp-hint").innerText = `驗證碼已傳送至 ${email}`;
            elements.msg.className = "message-box success";
            elements.msg.innerText = "請檢查您的收件匣";
          } else {
            elements.msg.className = "message-box error";
            elements.msg.innerText = data.error || "傳送失敗，請稍後再試";
          }
        } catch (e) {
          elements.msg.innerText = "網路連線異常";
        } finally {
          setState('send', false);
        }
      };

      document.getElementById("btn-verify").onclick = async () => {
        const email = elements.emailInput.value.trim();
        const token = elements.otpInput.value.trim();
        if (token.length < 6) return;

        elements.msg.innerText = "";
        setState('verify', true);

        try {
          const res = await fetch("/auth/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, token }),
          });
          if (res.ok) {
            elements.msg.className = "message-box success";
            elements.msg.innerText = "校驗成功，進入主頁面...";
            setTimeout(() => (location.href = "/"), 800);
          } else {
            elements.msg.className = "message-box error";
            elements.msg.innerText = "驗證碼不正確或已失效";
            setState('verify', false);
          }
        } catch (e) {
          elements.msg.innerText = "驗證過程發生錯誤";
          setState('verify', false);
        }
      };

      document.getElementById("link-retry").onclick = (e) => {
        e.preventDefault();
        elements.stepOtp.classList.add("hidden");
        elements.stepEmail.classList.remove("hidden");
        elements.msg.innerText = "";
        elements.otpInput.value = "";
      };
    </script>
  </body>
</html>
