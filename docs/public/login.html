<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="æ¥µé›»è³‡è¨Š Apple MDM å°ˆæ¥­çŸ¥è­˜åº«èº«åˆ†é©—è­‰é é¢ã€‚"
    />
    <title>ç™»å…¥ | æ¥µé›»è³‡è¨Š Apple MDM çŸ¥è­˜åº«</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon-custom.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-hover: #0062cc;
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.4);
        --glass-shadow: 0 40px 100px rgba(0, 0, 0, 0.15);
        --text-main: #1d1d1f;
        --text-sec: #86868b;
        --error: #ff3b30;
        --success: #34c759;
        --radius: 24px;
        --transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
      }

      * {
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
      }

      body {
        font-family:
          "Inter",
          "Noto Sans TC",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background-color: #f5f5f7;
        background-image:
          radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.1) 0, transparent 50%),
          radial-gradient(
            at 100% 0%,
            rgba(90, 200, 250, 0.08) 0,
            transparent 50%
          ),
          radial-gradient(
            at 50% 100%,
            rgba(0, 122, 255, 0.05) 0,
            transparent 50%
          );
        background-size: 100% 100%;
        background-attachment: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        color: var(--text-main);
        overflow-x: hidden;
      }

      main {
        width: 100%;
        max-width: 440px;
        padding: 24px;
        z-index: 10;
      }

      .card {
        background: var(--glass-bg);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 56px 40px;
        border-radius: var(--radius);
        box-shadow: var(--glass-shadow);
        border: 1px solid var(--glass-border);
        text-align: center;
        transition: var(--transition);
        animation: cardEntry 1s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      @keyframes cardEntry {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }

        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 50px 120px rgba(0, 0, 0, 0.18);
      }

      .logo-wrapper {
        margin-bottom: 32px;
        display: flex;
        justify-content: center;
      }

      .logo {
        max-width: 140px;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.05));
      }

      h1 {
        font-size: 26px;
        font-weight: 700;
        margin: 0 0 12px 0;
        letter-spacing: -0.03em;
      }

      .subtitle {
        color: var(--text-sec);
        font-size: 15px;
        margin: 0 0 36px 0;
        line-height: 1.6;
        font-weight: 400;
      }

      .form-group {
        margin-bottom: 24px;
        text-align: left;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-sec);
        margin-bottom: 8px;
        margin-left: 4px;
      }

      input {
        width: 100%;
        padding: 16px 20px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 14px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.7);
        outline: none;
        transition: all 0.25s ease;
        font-family: inherit;
      }

      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.12);
        background: #fff;
      }

      button {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      button:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 122, 255, 0.25);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status-badge {
        font-size: 11px;
        padding: 5px 12px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(0, 0, 0, 0.04);
        color: var(--text-sec);
        font-weight: 500;
        margin-top: 24px;
        /* Reduced from 32px to balance with the new buttons below */
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ccc;
      }

      .status-online .dot {
        background: var(--success);
        box-shadow: 0 0 8px var(--success);
      }

      .status-offline .dot {
        background: var(--error);
      }

      .hidden {
        display: none !important;
      }

      .link-text {
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        margin-top: 20px;
        display: inline-block;
        transition: opacity 0.2s;
      }

      .link-text:hover {
        opacity: 0.8;
      }

      .message-box {
        min-height: 24px;
        margin-top: 20px;
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
      }

      .success {
        color: var(--success);
      }

      .error {
        color: var(--error);
      }

      .footer-note {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        font-size: 12px;
        color: #98989d;
        line-height: 1.8;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Control Row Styles (Theme & Lang) */
      .controls-row {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 20px 0 8px;
      }

      .control-btn {
        background: rgba(0, 0, 0, 0.04);
        color: var(--text-sec);
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 600;
        width: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        flex: 1;
        max-width: 160px;
      }

      .control-btn:hover {
        background: rgba(0, 0, 0, 0.08);
        color: var(--text-main);
        transform: translateY(-1px);
      }

      .control-btn:active {
        transform: translateY(0);
      }

      .control-icon {
        font-size: 16px;
      }

      /* Dark Mode Override Support */
      .dark {
        --glass-bg: rgba(28, 28, 30, 0.85);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-sec: #8e8e93;
      }

      .dark body {
        background-color: #000000;
        background-image:
          radial-gradient(
            at 0% 0%,
            rgba(10, 132, 255, 0.12) 0,
            transparent 40%
          ),
          radial-gradient(
            at 100% 0%,
            rgba(100, 210, 255, 0.1) 0,
            transparent 40%
          ),
          radial-gradient(
            at 50% 100%,
            rgba(10, 132, 255, 0.08) 0,
            transparent 50%
          );
      }

      .dark .card {
        background: var(--glass-bg);
        border-color: var(--glass-border);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      }

      .dark input {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.12);
        color: white;
      }

      .dark .control-btn {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.12);
        color: #98989d;
      }

      .dark .control-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
      }

      .dark .status-badge {
        background: rgba(255, 255, 255, 0.08);
      }

      .dark .footer-note {
        border-top-color: rgba(255, 255, 255, 0.1);
      }

      @media (prefers-color-scheme: dark) {
        .lang-btn {
          background: rgba(255, 255, 255, 0.15);
          border-color: rgba(255, 255, 255, 0.15);
          color: rgba(255, 255, 255, 0.8);
        }

        .lang-btn:hover {
          background: rgba(255, 255, 255, 0.22);
        }
      }
    </style>
  </head>

  <body>
    <!-- Language Switch Button - Responsive Positioning -->

    <main role="main">
      <div class="card">
        <header>
          <div class="logo-wrapper">
            <img src="/logo-square.png" alt="Logo" class="logo" />
          </div>
          <h1 data-i18n="title">èº«åˆ†é©—è­‰</h1>
          <p class="subtitle" data-i18n="subtitle">
            è«‹ä½¿ç”¨æ•™è‚²ç¶²åŸŸä¿¡ç®± (@*.edu.tw) ç™»å…¥<br />ä»¥å­˜å– MDM å°ˆæ¥­çŸ¥è­˜åº«
          </p>
        </header>

        <!-- Step 1: Email Input -->
        <section id="step-email">
          <div class="form-group">
            <label for="email" data-i18n="emailLabel">æ•™è‚²é›»å­éƒµä»¶åœ°å€</label>
            <input
              type="email"
              id="email"
              placeholder="username@school.edu.tw"
              required
              autocomplete="email"
              aria-required="true"
            />
          </div>
          <button id="btn-send" type="button">
            <div id="send-spinner" class="spinner hidden"></div>
            <span id="send-text" data-i18n="btnSend">å‚³é€é©—è­‰ç¢¼</span>
          </button>
        </section>

        <!-- Step 2: OTP Input -->
        <section id="step-otp" class="hidden">
          <p
            id="otp-hint"
            style="color: var(--text-sec); margin-bottom: 24px; font-size: 14px"
          ></p>
          <div class="form-group">
            <label for="otp" data-i18n="otpLabel">é©—è­‰ç¢¼</label>
            <input
              type="text"
              id="otp"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
              maxlength="6"
              inputmode="numeric"
              autocomplete="one-time-code"
              style="
                letter-spacing: 8px;
                text-align: center;
                font-weight: 700;
                font-size: 26px;
                padding-left: 28px;
              "
            />
          </div>
          <button id="btn-verify" type="button">
            <div id="verify-spinner" class="spinner hidden"></div>
            <span id="verify-text" data-i18n="btnVerify">ç™»å…¥ç³»çµ±</span>
          </button>
          <a href="#" id="link-retry" class="link-text" data-i18n="changeEmail"
            >æ›´æ›é›»å­éƒµä»¶</a
          >
        </section>

        <!-- Messages & Status -->
        <div id="message" class="message-box" aria-live="polite"></div>

        <div id="service-status" class="status-badge hidden">
          <span class="dot"></span>
          <span id="status-text"></span>
        </div>

        <!-- Settings Group: Integrated Theme & Language Switchers -->
        <div class="controls-row">
          <button id="btn-theme" class="control-btn" aria-label="Toggle Theme">
            <span id="theme-icon" class="control-icon">ğŸŒ“</span>
            <span id="theme-text" data-i18n="themeAuto">æ¨™é¡Œ</span>
          </button>
          <button
            id="btn-lang"
            class="control-btn"
            aria-label="Toggle Language"
          >
            <span class="control-icon">ğŸŒ</span>
            <span id="lang-text">English</span>
          </button>
        </div>

        <footer class="footer-note" data-i18n="footer">
          æœ¬ç³»çµ±ä½¿ç”¨å®‰å…¨ Cookie èˆ‡é›²ç«¯é‚Šç·£é‹ç®—æŠ€è¡“<br />
          ç¶­è­·æ‚¨çš„å­˜å–å®‰å…¨ &copy; 2026 æ¥µé›»è³‡è¨Š
        </footer>
      </div>
    </main>

    <script>
      // i18n Configuration
      const translations = {
        "zh-TW": {
          title: "èº«åˆ†é©—è­‰",
          subtitle:
            "è«‹ä½¿ç”¨æ•™è‚²ç¶²åŸŸä¿¡ç®± (@*.edu.tw) ç™»å…¥<br />ä»¥å­˜å– MDM å°ˆæ¥­çŸ¥è­˜åº«",
          emailLabel: "æ•™è‚²é›»å­éƒµä»¶åœ°å€",
          btnSend: "å‚³é€é©—è­‰ç¢¼",
          sending: "è«‹æ±‚ä¸­...",
          otpLabel: "é©—è­‰ç¢¼",
          btnVerify: "ç™»å…¥ç³»çµ±",
          verifying: "æ ¡é©—ä¸­...",
          changeEmail: "æ›´æ›é›»å­éƒµä»¶",
          statusOnline: "å·²é€£ç·šè‡³å®‰å…¨é©—è­‰ç¯€é»",
          statusOffline: "ç„¡æ³•é€£ç·šè‡³é©—è­‰æœå‹™",
          otpSent: "é©—è­‰ç¢¼å·²å‚³é€è‡³",
          checkInbox: "è«‹æª¢æŸ¥æ‚¨çš„æ”¶ä»¶åŒ£",
          invalidEmail: "è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­éƒµä»¶æ ¼å¼",
          verifySuccess: "æ ¡é©—æˆåŠŸï¼Œé€²å…¥ä¸»é é¢...",
          verifyError: "é©—è­‰ç¢¼ä¸æ­£ç¢ºæˆ–å·²å¤±æ•ˆ",
          networkError: "ç¶²è·¯é€£ç·šç•°å¸¸",
          themeDark: "æ·±è‰²æ¨¡å¼",
          themeLight: "æ·ºè‰²æ¨¡å¼",
          footer:
            "æœ¬ç³»çµ±ä½¿ç”¨å®‰å…¨ Cookie èˆ‡é›²ç«¯é‚Šç·£é‹ç®—æŠ€è¡“<br />ç¶­è­·æ‚¨çš„å­˜å–å®‰å…¨ &copy; 2026 æ¥µé›»è³‡è¨Š",
        },
        en: {
          title: "Authentication",
          subtitle:
            "Please login with your education email (@*.edu.tw)<br />to access the MDM Knowledge Base",
          emailLabel: "Education Email Address",
          btnSend: "Send Verification Code",
          sending: "Sending...",
          otpLabel: "Verification Code",
          btnVerify: "Sign In",
          verifying: "Verifying...",
          changeEmail: "Change Email",
          statusOnline: "Connected to Secure Auth Node",
          statusOffline: "Unable to connect to Auth Service",
          otpSent: "Verification code sent to",
          checkInbox: "Please check your inbox",
          invalidEmail: "Please enter a valid email address",
          verifySuccess: "Success! Redirecting...",
          verifyError: "Invalid or expired verification code",
          networkError: "Network connection error",
          themeDark: "Dark Mode",
          themeLight: "Light Mode",
          footer:
            "Secured by Secure Cookie & Edge Computing<br />&copy; 2026 Superinfo Computer Co., Ltd.",
        },
      };

      let currentLang = "zh-TW";
      let currentStatus = "online";
      let currentTheme = "auto";

      const updateLanguage = (lang) => {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.getElementById("lang-text").innerText =
          lang === "zh-TW" ? "English" : "ç¹é«”ä¸­æ–‡";

        // Update all data-i18n elements
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (translations[lang][key]) {
            el.innerHTML = translations[lang][key];
          }
        });

        // Update Service Status Text
        const statusText = document.getElementById("status-text");
        if (statusText) {
          statusText.innerText =
            currentStatus === "online"
              ? translations[lang].statusOnline
              : translations[lang].statusOffline;
        }

        // Update Theme Button Text
        updateThemeUI();

        // Update Dynamic Placeholders/Messages if visible
        const otpHint = document.getElementById("otp-hint");
        if (otpHint && otpHint.innerText.includes("@")) {
          const email = document.getElementById("email").value;
          otpHint.innerText = `${translations[lang].otpSent} ${email}`;
        }
      };

      // Auto-detect Language
      const detectLanguage = () => {
        const savedLang = localStorage.getItem("user-language");
        if (savedLang) return savedLang;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("lang") === "en") return "en";

        const browserLang = navigator.language || navigator.userLanguage;
        return browserLang.toLowerCase().startsWith("zh") ? "zh-TW" : "en";
      };

      // Theme Management
      const updateThemeUI = () => {
        const isDark = document.documentElement.classList.contains("dark");
        document.getElementById("theme-icon").innerText = isDark ? "ğŸŒ™" : "â˜€ï¸";
        document.getElementById("theme-text").innerText = isDark
          ? translations[currentLang].themeDark
          : translations[currentLang].themeLight;
      };

      const applyTheme = (theme) => {
        currentTheme = theme;
        localStorage.setItem("user-theme", theme);

        if (theme === "auto") {
          const systemDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          document.documentElement.classList.toggle("dark", systemDark);
        } else {
          document.documentElement.classList.toggle("dark", theme === "dark");
        }
        updateThemeUI();
      };

      const detectTheme = () => {
        const savedTheme = localStorage.getItem("user-theme");
        return savedTheme || "auto";
      };

      // Initialization
      currentLang = detectLanguage();
      currentTheme = detectTheme();

      applyTheme(currentTheme);
      updateLanguage(currentLang);

      // Event Listeners
      document.getElementById("btn-lang").onclick = () => {
        const newLang = currentLang === "zh-TW" ? "en" : "zh-TW";
        localStorage.setItem("user-language", newLang);
        updateLanguage(newLang);
      };

      document.getElementById("btn-theme").onclick = () => {
        const isCurrentlyDark =
          document.documentElement.classList.contains("dark");
        applyTheme(isCurrentlyDark ? "light" : "dark");
      };

      // Listen for system theme changes if set to auto
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          if (currentTheme === "auto") {
            applyTheme("auto");
          }
        });

      const elements = {
        stepEmail: document.getElementById("step-email"),
        stepOtp: document.getElementById("step-otp"),
        emailInput: document.getElementById("email"),
        otpInput: document.getElementById("otp"),
        msg: document.getElementById("message"),
        serviceStatus: document.getElementById("service-status"),
        statusText: document.getElementById("status-text"),
        btnSend: document.getElementById("btn-send"),
        btnVerify: document.getElementById("btn-verify"),
        sendSpinner: document.getElementById("send-spinner"),
        verifySpinner: document.getElementById("verify-spinner"),
        sendText: document.getElementById("send-text"),
        verifyText: document.getElementById("verify-text"),
      };

      const log = (msg) => console.log(`[AuthSystem] ${msg}`);

      // åˆå§‹åŒ–ï¼šè™•ç†å‚³å›çš„ Magic Link Token
      const getParams = () => {
        const hash = window.location.hash.substring(1);
        const search = window.location.search.substring(1);
        const p = new URLSearchParams(hash || search);
        return p;
      };

      const params = getParams();
      const accessToken = params.get("access_token");

      if (accessToken) {
        log("åµæ¸¬åˆ°å­˜å–ä»¤ç‰Œï¼Œæ­£åœ¨å»ºç«‹å·¥ä½œéšæ®µ...");
        elements.stepEmail.classList.add("hidden");
        elements.msg.className = "message-box success";
        elements.msg.innerHTML =
          '<div class="spinner" style="display:inline-block; border-top-color:var(--success); margin-right:10px;"></div> Verification successful, creating session...';

        fetch("/auth/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ access_token: accessToken }),
        })
          .then(async (res) => {
            if (res.ok) {
              log("æœƒè©±å»ºç«‹æˆåŠŸï¼Œæº–å‚™å°å‘...");
              setTimeout(
                () => (location.href = currentLang === "en" ? "/en/" : "/"),
                500
              );
            } else {
              const err = await res.json();
              elements.msg.className = "message-box error";
              elements.msg.innerText = `Error: ${err.error || "Invalid Token"}`;
              elements.stepEmail.classList.remove("hidden");
            }
          })
          .catch(() => {
            elements.msg.className = "message-box error";
            elements.msg.innerText = translations[currentLang].networkError;
            elements.stepEmail.classList.remove("hidden");
          });
      }

      // æœå‹™ç›£æ¸¬
      (async () => {
        try {
          const res = await fetch("/auth/health");
          if (!res.ok) throw new Error();
          const data = await res.json();
          elements.serviceStatus.classList.remove("hidden");
          if (data.status === "online") {
            currentStatus = "online";
            elements.statusText.innerText =
              translations[currentLang].statusOnline;
            elements.serviceStatus.className = "status-badge status-online";
          }
        } catch (e) {
          currentStatus = "offline";
          elements.serviceStatus.classList.remove("hidden");
          elements.statusText.innerText =
            translations[currentLang].statusOffline;
          elements.serviceStatus.className = "status-badge status-offline";
        }
      })();

      // UI è¼”åŠ©å‡½å¼
      const setState = (action, loading) => {
        if (action === "send") {
          elements.btnSend.disabled = loading;
          elements.sendSpinner.classList.toggle("hidden", !loading);
          elements.sendText.innerText = loading
            ? translations[currentLang].sending
            : translations[currentLang].btnSend;
        } else {
          elements.btnVerify.disabled = loading;
          elements.verifySpinner.classList.toggle("hidden", !loading);
          elements.verifyText.innerText = loading
            ? translations[currentLang].verifying
            : translations[currentLang].btnVerify;
        }
      };

      // äº‹ä»¶ç›£è½
      document.getElementById("btn-send").onclick = async () => {
        const email = elements.emailInput.value.trim();
        if (!email || !email.includes("@")) {
          elements.msg.className = "message-box error";
          elements.msg.innerText = translations[currentLang].invalidEmail;
          return;
        }

        elements.msg.innerText = "";
        setState("send", true);

        try {
          const res = await fetch("/auth/otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          const data = await res.json();

          if (res.ok) {
            elements.stepEmail.classList.add("hidden");
            elements.stepOtp.classList.remove("hidden");
            document.getElementById("otp-hint").innerText =
              `${translations[currentLang].otpSent} ${email}`;
            elements.msg.className = "message-box success";
            elements.msg.innerText = translations[currentLang].checkInbox;
          } else {
            elements.msg.className = "message-box error";
            elements.msg.innerText = data.error || "Failed. Please try again.";
          }
        } catch (e) {
          elements.msg.innerText = translations[currentLang].networkError;
        } finally {
          setState("send", false);
        }
      };

      document.getElementById("btn-verify").onclick = async () => {
        const email = elements.emailInput.value.trim();
        const token = elements.otpInput.value.trim();
        if (token.length < 6) return;

        elements.msg.innerText = "";
        setState("verify", true);

        try {
          const res = await fetch("/auth/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, token }),
          });
          if (res.ok) {
            elements.msg.className = "message-box success";
            elements.msg.innerText = translations[currentLang].verifySuccess;
            setTimeout(
              () => (location.href = currentLang === "en" ? "/en/" : "/"),
              800
            );
          } else {
            elements.msg.className = "message-box error";
            elements.msg.innerText = translations[currentLang].verifyError;
            setState("verify", false);
          }
        } catch (e) {
          elements.msg.innerText = translations[currentLang].networkError;
          setState("verify", false);
        }
      };

      document.getElementById("link-retry").onclick = (e) => {
        e.preventDefault();
        elements.stepOtp.classList.add("hidden");
        elements.stepEmail.classList.remove("hidden");
        elements.msg.innerText = "";
        elements.otpInput.value = "";
      };
    </script>
  </body>
</html>
