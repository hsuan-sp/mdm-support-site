<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™»å…¥ | æ¥µé›»è³‡è¨Š Apple MDM çŸ¥è­˜åº«</title>
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #007aff;
        --primary-hover: #0062cc;
        --bg-gradient: radial-gradient(
          circle at 50% 0%,
          #f0f4ff 0%,
          #f5f5f7 100%
        );
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 20px 60px rgba(0, 0, 0, 0.08); /* Softer shadow */
        --text-main: #1d1d1f;
        --text-sec: #86868b;
        --error: #ff3b30;
        --success: #34c759;
      }

      body {
        font-family: "Inter", "Noto Sans TC", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        color: var(--text-main);
        /* Subtle background animation */
        background-size: 200% 200%;
        animation: bgBreath 15s ease infinite;
      }

      @keyframes bgBreath {
        0% {
          background-position: 50% 0%;
        }
        50% {
          background-position: 50% 100%;
        }
        100% {
          background-position: 50% 0%;
        }
      }

      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
      }

      .card {
        background: var(--glass-bg);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        padding: 48px 40px;
        border-radius: 24px;
        box-shadow: var(--glass-shadow);
        border: 1px solid var(--glass-border);
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
      }

      .logo {
        width: 64px;
        height: 64px;
        margin-bottom: 24px;
        border-radius: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      h1 {
        font-size: 26px;
        font-weight: 700;
        margin: 0 0 12px 0;
        letter-spacing: -0.01em;
        background: linear-gradient(135deg, #1d1d1f 0%, #434344 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      p.subtitle {
        color: var(--text-sec);
        font-size: 15px;
        margin: 0 0 32px 0;
        line-height: 1.5;
        font-weight: 400;
      }

      .input-group {
        margin-bottom: 20px;
        text-align: left;
        position: relative;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-sec);
        margin-bottom: 8px;
        margin-left: 4px;
      }

      input {
        width: 100%;
        padding: 16px 16px;
        border: 1px solid #d1d1d6;
        border-radius: 14px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.8);
        box-sizing: border-box;
        outline: none;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        font-family: inherit;
      }

      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
        background: #fff;
      }

      input::placeholder {
        color: #aaa;
      }

      button {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 8px;
        position: relative;
        overflow: hidden;
      }

      button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
      }

      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: #e5e5ea;
        color: #aeaeb2;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Status Badge */
      .status-badge {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(0, 0, 0, 0.04);
        color: var(--text-sec);
        font-weight: 500;
        margin-top: 24px;
      }
      .status-badge.online::before {
        content: "";
        display: block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
      }
      .status-badge.offline::before {
        content: "";
        display: block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--error);
      }

      /* Utility */
      .hidden {
        display: none !important;
      }
      .link-text {
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        margin-top: 16px;
        display: inline-block;
        transition: opacity 0.2s;
      }
      .link-text:hover {
        opacity: 0.8;
      }

      .message-box {
        min-height: 24px;
        margin-top: 16px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
      }
      .success {
        color: var(--success);
      }
      .error {
        color: var(--error);
      }

      .footer-note {
        margin-top: 32px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        font-size: 12px;
        color: #98989d;
        line-height: 1.6;
      }

      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
        display: none; /* hidden by default */
      }
      button.loading .spinner {
        display: inline-block;
      }
      button.loading span {
        opacity: 0.8;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <img src="/superinfo_logo.png" alt="Logo" class="logo" />
        <h1>èº«åˆ†é©—è­‰</h1>
        <p class="subtitle">
          è«‹ä½¿ç”¨æ•™è‚²ç¶²åŸŸä¿¡ç®± (@*.edu.tw) ç™»å…¥<br />ä»¥å­˜å– MDM å°ˆæ¥­çŸ¥è­˜åº«
        </p>

        <div id="step-email">
          <div class="input-group">
            <label for="email">é›»å­éƒµä»¶</label>
            <input
              type="email"
              id="email"
              placeholder="name@school.edu.tw"
              required
              autocomplete="email"
            />
          </div>
          <button id="btn-send">
            <div class="spinner"></div>
            <span>å‚³é€é©—è­‰ç¢¼</span>
          </button>
        </div>

        <div id="step-otp" class="hidden">
          <p
            id="otp-hint"
            style="color: var(--text-sec); margin-bottom: 20px; font-size: 14px"
          ></p>
          <div class="input-group">
            <label for="otp">é©—è­‰ç¢¼</label>
            <input
              type="text"
              id="otp"
              placeholder="6 ä½æ•¸ä»£ç¢¼"
              maxlength="6"
              autocomplete="one-time-code"
              style="
                letter-spacing: 4px;
                text-align: center;
                font-weight: 600;
                font-size: 20px;
              "
            />
          </div>
          <button id="btn-verify">
            <div class="spinner"></div>
            <span>ç™»å…¥ç³»çµ±</span>
          </button>
          <a href="#" id="link-retry" class="link-text">æ›´æ› Email</a>
        </div>

        <div id="message" class="message-box"></div>

        <div id="status" class="status-badge hidden">...</div>

        <div class="footer-note">
          æœ¬ç³»çµ±ä½¿ç”¨å®‰å…¨ Cookie æŠ€è¡“ç¶­æŒç™»å…¥ç‹€æ…‹<br />
          æˆ‘å€‘ä¸æœƒå„²å­˜æ‚¨çš„ä»»ä½•æ•æ„Ÿå€‹è³‡
        </div>
      </div>
    </div>

    <script>
      const stepEmail = document.getElementById("step-email");
      const stepOtp = document.getElementById("step-otp");
      const emailInput = document.getElementById("email");
      const otpInput = document.getElementById("otp");
      const msg = document.getElementById("message");
      const statusBadge = document.getElementById("status");

      function log(msg) {
        console.log(`[Auth] ${msg}`);
      }

      // Magic Link è™•ç†
      const hash = window.location.hash.substring(1);
      const search = window.location.search.substring(1);

      // ... (Magic Link logic remains same) ...
      const hashParams = new URLSearchParams(hash);
      const searchParams = new URLSearchParams(search);
      let accessToken =
        hashParams.get("access_token") || searchParams.get("access_token");

      if (accessToken) {
        log("æ­£åœ¨ç™»å…¥ä¸¦ç´€éŒ„...");
        fetch("/auth/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ access_token: accessToken }),
        }).then((res) => {
          if (res.ok) {
            location.href = "/";
          } else {
            log("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
          }
        });
      } else if (hashParams.get("error_description")) {
        document.getElementById("message").className = "error";
        document.getElementById("message").innerText =
          hashParams.get("error_description");
      }

      // å•Ÿå‹•æ™‚æª¢æŸ¥æœå‹™ç‹€æ…‹
      (async () => {
        try {
          const res = await fetch("/auth/health");
          const data = await res.json();
          if (data.status === "online") {
            statusBadge.innerText = "ğŸŸ¢ é©—è­‰æœå‹™é‹ä½œä¸­";
            statusBadge.className = "status-badge status-online";
          } else {
            statusBadge.innerText = "âš ï¸ é©—è­‰æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨";
            statusBadge.className = "status-badge status-offline";
          }
        } catch (e) {
          statusBadge.innerText = "âš ï¸ ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨";
          statusBadge.className = "status-badge status-offline";
        }
      })();

        // Helper to toggle loading state
        function setLoading(btnId, isLoading, text) {
            const btn = document.getElementById(btnId);
            const span = btn.querySelector('span');
            if (isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
                if (text) span.innerText = text;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
                if (text) span.innerText = text;
            }
        }

        // åˆå§‹åŒ–ï¼šé»æ“Šé‡æ–°è¼¸å…¥æ™‚çš„è¡Œç‚º
        document.getElementById('link-retry').onclick = (e) => {
            e.preventDefault();
            stepOtp.classList.add('hidden');
            stepEmail.classList.remove('hidden');
            msg.innerText = '';
            document.getElementById('otp').value = '';
        };

        // åˆå§‹åŒ–ï¼šæª¢æŸ¥æ˜¯å¦æœ‰å…ˆå‰è¼¸å…¥çš„ Email
        if (emailInput.value && !stepOtp.classList.contains('hidden')) {
            // Pass
        } else {
            stepEmail.classList.remove('hidden');
            stepOtp.classList.add('hidden');
        }

        document.getElementById('btn-send').onclick = async () => {
            const email = emailInput.value.trim();
            if (!email) return;
            
            msg.className = 'message-box';
            msg.innerText = '';
            setLoading('btn-send', true, 'ç™¼é€ä¸­...');
            
            try {
                const res = await fetch('/auth/otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                
                if (res.ok) {
                    stepEmail.classList.add('hidden');
                    stepOtp.classList.remove('hidden');
                    document.getElementById('otp-hint').innerText = `é©—è­‰ç¢¼å·²å¯„é€åˆ° ${email}`;
                    msg.className = 'message-box success';
                    msg.innerText = '';
                    setLoading('btn-send', false, 'å‚³é€é©—è­‰ç¢¼');
                } else {
                    msg.className = 'message-box error';
                    msg.innerText = data.error_description || data.error || data.msg || 'ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å€™å†è©¦';
                    
                    // å€’æ•¸è¨ˆæ™‚
                    let countdown = 60;
                    setLoading('btn-send', true, `è«‹ç­‰å¾… ${countdown} ç§’`); // Keep disabled
                    
                    const timer = setInterval(() => {
                        const btn = document.getElementById('btn-send');
                        const span = btn.querySelector('span');
                        span.innerText = `è«‹ç­‰å¾… ${countdown} ç§’`;
                        
                        if (countdown <= 0) {
                            clearInterval(timer);
                            setLoading('btn-send', false, 'å‚³é€é©—è­‰ç¢¼');
                            msg.innerText = '';
                        }
                        countdown--;
                    }, 1000);
                }
            } catch (e) {
                msg.className = 'message-box error';
                msg.innerText = 'é€£ç·šå¤±æ•—';
                setLoading('btn-send', false, 'å‚³é€é©—è­‰ç¢¼');
            }
        };

        document.getElementById('btn-verify').onclick = async () => {
            const email = emailInput.value.trim();
            const token = otpInput.value.trim();
            
            msg.className = 'message-box';
            msg.innerText = '';
            setLoading('btn-verify', true, 'é©—è­‰ä¸­...');
            
            try {
                const res = await fetch('/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, token })
                });
                
                if (res.ok) {
                    msg.className = 'message-box success';
                    msg.innerText = 'ç™»å…¥æˆåŠŸï¼æ­£åœ¨è·³è½‰...';
                    setTimeout(() => location.href = '/', 500);
                } else {
                    const data = await res.json();
                    msg.className = 'message-box error';
                    msg.innerText = data.error || 'é©—è­‰ç¢¼éŒ¯èª¤';
                    setLoading('btn-verify', false, 'ç™»å…¥ç³»çµ±');
                }
            } catch (e) {
                msg.className = 'message-box error';
                msg.innerText = 'é©—è­‰å¤±æ•—';
                setLoading('btn-verify', false, 'ç™»å…¥ç³»çµ±');
            }
        };
    </script>
  </body>
</html>
